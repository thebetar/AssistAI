<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<title>Manage Documents</title>
		<link rel="stylesheet" href="/static/style.css" />

		<script>
			window.__INITIAL_STATE__ = {
				pending: {% if pending %}true{% else %}false{% endif %}
			};
		</script>
	</head>
	<body>
		<div id="root"></div>
		<script type="module">
			import { createSignal, onCleanup, onMount } from 'https://esm.sh/solid-js@1.8.1';
			import { render } from 'https://esm.sh/solid-js@1.8.1/web';
			import html from 'https://esm.sh/solid-js@1.8.1/html';

			import { PendingNotification } from '/static/pending-notification.js';
			import { SettingsGear } from '/static/settings-gear.js';

			const App = () => {
				const [pending, setPending] = createSignal(window.__INITIAL_STATE__.pending || false);

				const [files, setFiles] = createSignal([]);
				const [fileFilter, setFileFilter] = createSignal('');
				const [showAllFiles, setShowAllFiles] = createSignal(false);

				// --- URL sources state ---
				const [urls, setUrls] = createSignal([]);
				const [urlInput, setUrlInput] = createSignal('');
				const [urlFilter, setUrlFilter] = createSignal('');
				const [showAllUrls, setShowAllUrls] = createSignal(false);

				const fetchFiles = async () => {
					const res = await fetch('/manage/files');
					const data = await res.json();
					setFiles(data.files || []);
				};

				const fetchUrls = async () => {
					const res = await fetch('/manage/urls');
					const data = await res.json();
					setUrls(data.urls || []);
				};

				onMount(() => {
					fetchFiles();
					fetchUrls();
				});

				const handleUpload = async e => {
					e.preventDefault();
					const form = e.target;
					const formData = new FormData(form);

					const res = await fetch('/manage/upload', {
						method: 'POST',
						body: formData,
					});

					const data = await res.json();

					setFiles(data.files || []);
					setPending(true);

					form.reset();
				};

				const handleDelete = async (e, filename) => {
					e.preventDefault();

					const res = await fetch(`/manage/delete/${encodeURIComponent(filename)}`, {
						method: 'DELETE',
					});

					const data = await res.json();
					setFiles(data.files || []);
					setPending(true);
				};

				// --- Add URL handler ---
				const handleAddUrl = async e => {
					e.preventDefault();
					const url = urlInput().trim();
					if (!url) return;
					const res = await fetch('/manage/add_url', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ url }),
					});
					const data = await res.json();
					setUrls(data.urls || []);
					setPending(true);
					setUrlInput('');
				};

				// --- Delete URL handler ---
				const handleDeleteUrl = async (e, urlId) => {
					e.preventDefault();
					const res = await fetch(`/manage/delete_url/${encodeURIComponent(urlId)}`, {
						method: 'DELETE',
					});
					const data = await res.json();
					setUrls(data.urls || []);
					setPending(true);
				};

				const filteredFiles = () =>
					files().filter(f => f.toLowerCase().includes(fileFilter().trim().toLowerCase()));

				const filteredUrls = () =>
					urls().filter(u => u.url.toLowerCase().includes(urlFilter().trim().toLowerCase()));

				return html`
					${() => (pending() ? PendingNotification({ setPending }) : null)}

					<div class="container">
						${SettingsGear()}

						<h1>Manage Sources</h1>

						<div class="documents-info">
							These documents are used as the knowledge base for answering your questions.
							<a class="btn documents-info-button" href="/">
								<svg
									width="16px"
									height="16px"
									viewBox="0 0 24 24"
									fill="none"
									xmlns="http://www.w3.org/2000/svg"
								>
									<path
										d="M3 10C3 6.22876 3 4.34315 4.17157 3.17157C5.34315 2 7.22876 2 11 2H13C16.7712 2 18.6569 2 19.8284 3.17157C21 4.34315 21 6.22876 21 10V14C21 17.7712 21 19.6569 19.8284 20.8284C18.6569 22 16.7712 22 13 22H11C7.22876 22 5.34315 22 4.17157 20.8284C3 19.6569 3 17.7712 3 14V10Z"
										stroke="currentColor"
										stroke-width="1.5"
									/>
									<path
										d="M8 12H16"
										stroke="currentColor"
										stroke-width="1.5"
										stroke-linecap="round"
									/>
									<path d="M8 8H16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
									<path
										d="M8 16H13"
										stroke="currentColor"
										stroke-width="1.5"
										stroke-linecap="round"
									/>
								</svg>
								Back to Chat
							</a>
						</div>

						<!-- URL Sources Section -->
						<h2>URL Sources</h2>

						<form class="upload-form" onSubmit=${handleAddUrl} style="margin-bottom: 1em;">
							<input
								type="url"
								placeholder="Add URL (https://...)"
								class="upload-input"
								required
								value=${urlInput()}
								onInput=${e => setUrlInput(e.target.value)}
								style="width: 70%; margin-right: 8px;"
							/>
							<button type="submit" class="btn upload-btn">Add URL</button>
						</form>

						<div style="display: flex; margin-bottom: 0.5em;">
							<input
								type="text"
								id="url-filter"
								placeholder="Filter URLs..."
								class="form-input"
								style="flex: 1;"
								autocomplete="off"
								value=${urlFilter()}
								onInput=${e => setUrlFilter(e.target.value)}
							/>
						</div>

						<ul class="manage-list">
							${() => {
								const urlsToShow = showAllUrls() ? filteredUrls() : filteredUrls().slice(0, 3);

								return urlsToShow.length > 0
									? urlsToShow.map(
											urlObj =>
												html`
													<li class="manage-list-item">
														<a
															href="${urlObj.url}"
															class="manage-filename"
															style="word-break: break-all;"
															target="_blank"
														>
															${urlObj.url}
														</a>
														<span class="manage-actions">
															<form
																style="width: 100%; margin: 0; display: inline"
																onSubmit=${e => handleDeleteUrl(e, urlObj.id)}
															>
																<button
																	type="submit"
																	class="manage-action-btn manage-delete-btn"
																>
																	<svg
																		width="14px"
																		height="14px"
																		viewBox="0 0 24 24"
																		fill="none"
																		xmlns="http://www.w3.org/2000/svg"
																		style="vertical-align: middle; margin-right: 4px;"
																	>
																		<path
																			d="M3 6H5H21"
																			stroke="currentColor"
																			stroke-width="2"
																			stroke-linecap="round"
																			stroke-linejoin="round"
																		/>
																		<path
																			d="M8 6V4C8 2.89543 8.89543 2 10 2H14C15.1046 2 16 2.89543 16 4V6M19 6V20C19 21.1046 18.1046 22 17 22H7C5.89543 22 5 21.1046 5 20V6M10 11V17M14 11V17"
																			stroke="currentColor"
																			stroke-width="2"
																			stroke-linecap="round"
																			stroke-linejoin="round"
																		/>
																	</svg>
																	Delete
																</button>
															</form>
														</span>
													</li>
												`,
									  )
									: html`<li style="color: #888; padding: 8px">No URLs added.</li>`;
							}}
						</ul>

						${() =>
							filteredUrls().length > 3
								? html`
										<div
											style="display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 1em;"
										>
											Only the first 3 URLs are shown from the search result.
											<button
												type="button"
												class="btn secondary-btn-outline"
												onClick=${() => setShowAllUrls(v => !v)}
											>
												${showAllUrls() ? 'Show less' : 'Show all'}
											</button>
										</div>
								  `
								: null}
						<!-- End URL Sources Section -->

						<!-- Files Section -->
						<h2>Notes</h2>

						<form
							action="/manage/upload"
							method="post"
							enctype="multipart/form-data"
							class="upload-form"
							onSubmit=${handleUpload}
						>
							<input type="file" name="files" multiple required class="upload-input" />
							<button type="submit" class="btn upload-btn">
								<svg
									width="16px"
									height="16px"
									viewBox="0 0 24 24"
									fill="none"
									xmlns="http://www.w3.org/2000/svg"
								>
									<path
										d="M12 4V16M12 4L8 8M12 4L16 8"
										stroke="currentColor"
										stroke-width="2"
										stroke-linecap="round"
										stroke-linejoin="round"
									/>
									<rect x="4" y="20" width="16" height="2" rx="1" fill="currentColor" stroke="none" />
								</svg>

								Upload
							</button>
						</form>

						<div style="display: flex;">
							<input
								type="text"
								id="file-filter"
								placeholder="Filter files..."
								class="form-input"
								style="flex: 1;"
								autocomplete="off"
								value=${() => fileFilter()}
								onInput=${e => setFileFilter(e.target.value)}
							/>
						</div>

						<ul class="manage-list">
							${() => {
								const filesToShow = showAllFiles() ? filteredFiles() : filteredFiles().slice(0, 3);
								return filesToShow.length > 0
									? filesToShow.map(
											file =>
												html`
													<li class="manage-list-item">
														<span class="manage-filename">${file}</span>
														<span class="manage-actions">
															<a
																href=${`/manage/view/${encodeURIComponent(file)}`}
																target="_blank"
																class="manage-action-btn"
																style="background: #6c757d; margin-bottom: 8px"
															>
																<svg
																	width="14px"
																	height="14px"
																	viewBox="0 0 24 24"
																	fill="none"
																	xmlns="http://www.w3.org/2000/svg"
																	style="vertical-align: middle; margin-right: 4px;"
																>
																	<path
																		d="M1 12C1 12 5 5 12 5C19 5 23 12 23 12C23 12 19 19 12 19C5 19 1 12 1 12Z"
																		stroke="currentColor"
																		stroke-width="2"
																		stroke-linecap="round"
																		stroke-linejoin="round"
																	/>
																	<circle
																		cx="12"
																		cy="12"
																		r="3"
																		stroke="currentColor"
																		stroke-width="2"
																		stroke-linecap="round"
																		stroke-linejoin="round"
																	/>
																</svg>
																View
															</a>
															<a
																href=${`/manage/download/${encodeURIComponent(file)}`}
																target="_blank"
																class="manage-action-btn manage-download-btn"
																style="margin-bottom: 8px"
															>
																<svg
																	width="16px"
																	height="16px"
																	viewBox="0 0 24 24"
																	fill="none"
																	xmlns="http://www.w3.org/2000/svg"
																>
																	<path
																		d="M12 16V4M12 16L8 12M12 16L16 12"
																		stroke="currentColor"
																		stroke-width="2"
																		stroke-linecap="round"
																		stroke-linejoin="round"
																	/>
																	<rect
																		x="4"
																		y="18"
																		width="16"
																		height="2"
																		rx="1"
																		fill="currentColor"
																		stroke="none"
																	/>
																</svg>
																Download
															</a>
															<form
																style="width: 100%; margin: 0; display: inline"
																onSubmit=${e => handleDelete(e, file)}
															>
																<button
																	type="submit"
																	class="manage-action-btn manage-delete-btn"
																>
																	<svg
																		width="14px"
																		height="14px"
																		viewBox="0 0 24 24"
																		fill="none"
																		xmlns="http://www.w3.org/2000/svg"
																		style="vertical-align: middle; margin-right: 4px;"
																	>
																		<path
																			d="M3 6H5H21"
																			stroke="currentColor"
																			stroke-width="2"
																			stroke-linecap="round"
																			stroke-linejoin="round"
																		/>
																		<path
																			d="M8 6V4C8 2.89543 8.89543 2 10 2H14C15.1046 2 16 2.89543 16 4V6M19 6V20C19 21.1046 18.1046 22 17 22H7C5.89543 22 5 21.1046 5 20V6M10 11V17M14 11V17"
																			stroke="currentColor"
																			stroke-width="2"
																			stroke-linecap="round"
																			stroke-linejoin="round"
																		/>
																	</svg>
																	Delete
																</button>
															</form>
														</span>
													</li>
												`,
									  )
									: html`<li style="color: #888; padding: 8px">No files found.</li>`;
							}}
						</ul>

						${() =>
							filteredFiles().length > 3
								? html`
										<div
											style="display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 1em;"
										>
											Only the first 3 files are shown from the search result.
											<button
												type="button"
												class="btn secondary-btn-outline"
												onClick=${() => setShowAllFiles(v => !v)}
											>
												${showAllFiles() ? 'Show less' : 'Show all'}
											</button>
										</div>
								  `
								: null}
						<!-- End Files Section -->
					</div>
				`;
			};

			render(App, document.getElementById('root'));
		</script>
	</body>
</html>
