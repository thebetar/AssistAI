<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<title>Assist AI Client</title>
		<link rel="stylesheet" href="/static/style.css" />

		<script>
			let loading = false;
			let timerInterval = null;
			let startTime = null;

			function startLoading() {
				loading = true;
				document.getElementById('loading-row').style.display = 'flex';
				const responseDiv = document.getElementById('response-block');

				if (responseDiv) {
					responseDiv.style.display = 'none';
				}

				startTime = Date.now();
				updateTimer();
				timerInterval = setInterval(updateTimer, 100);
			}

			function stopLoading() {
				loading = false;
				document.getElementById('loading-row').style.display = 'none';
				clearInterval(timerInterval);
				const responseDiv = document.getElementById('response-block');
				if (responseDiv) {
					responseDiv.style.display = 'block';
				}
			}

			function updateTimer() {
				if (!loading) {
					return;
				}

				const now = Date.now();
				const elapsed = ((now - startTime) / 1000).toFixed(1);
				document.getElementById('timer').textContent = elapsed + 's';
			}

			window.addEventListener('DOMContentLoaded', function () {
				const form = document.querySelector('.question-form');

				if (!form) {
					return;
				}

				form.addEventListener('submit', function () {
					startLoading();
				});
				// Hide response on submit if still visible
				const responseDiv = document.getElementById('response-block');

				if (!responseDiv) {
					return;
				}

				responseDiv.style.display =
					'{{ response is defined and response is not none }}' === 'True' ? '' : 'none';
			});
		</script>
	</head>
	<body>
		<div class="container">
			<h1>Assist AI</h1>

			<div class="documents-info">
				Assist AI runs locally and answers your questions using the provided documents (in Markdown format) and
				your chat history. With efficient RAG, the model can use a large number of notes as context. You can
				also ask questions without RAG for faster responses. To manage your documents, click the button below.
				To clear the chat history, type "clear".
				<a class="documents-info-button" href="/manage">Manage Documents</a>
			</div>

			<form method="post" class="question-form">
				<div class="question-form-row">
					<input
						type="text"
						name="question"
						placeholder="Enter your question"
						value="{{ question or '' }}"
						required
					/>
					<button class="question-form-submit" type="submit">Ask</button>
					<button class="question-form-clear" type="submit" name="clear" value="true">Clear</button>
				</div>

				<div class="question-form-row">
					<label style="margin-top: 1em; display: inline-block">
						<input type="checkbox" name="use_rag" value="on" {% if use_rag %}checked{% endif %} />
						Provide answer based on documents
					</label>
				</div>
			</form>

			<div id="loading-row" class="loading-row" style="display: none">
				<div class="loader"></div>
				<span>Loading...</span>
				<span id="timer" class="loading-timer">0.0s</span>
			</div>

			{% if response %}
			<script>
				stopLoading();
			</script>

			<div class="response" id="response-block">
				<h2>Response {% if use_rag %}(RAG){% endif %}:</h2>
				<div class="response-scroll">{{ response }}</div>
			</div>
			{% else %}
			<div id="response-block" style="display: none"></div>
			{% endif %} {% if history %}
			<div class="chat-history">
				<h2>Chat History</h2>
				<div class="chat-history-scroll">
					{% for entry in history %}
					<div class="chat-history-entry">
						<strong>You:</strong> {{ entry[0] }}<br />
						<strong>AI:</strong> {{ entry[1] }}
					</div>
					{% endfor %}
				</div>
			</div>
			{% endif %}
		</div>
	</body>
</html>
