<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<title>Assist AI Client</title>
		<link rel="stylesheet" href="/static/style.css" />

		<script>
			window.__INITIAL_STATE__ = {
				history: {% if history %}{{ history|tojson }}{% else %}[]{% endif %}
			};
		</script>
	</head>
	<body>
		<div id="root"></div>
		<script type="module">
			import { createSignal, onCleanup } from 'https://esm.sh/solid-js@1.8.1';
			import { render } from 'https://esm.sh/solid-js@1.8.1/web';
			import html from 'https://esm.sh/solid-js@1.8.1/html';

			const App = () => {
				const [question, setQuestion] = createSignal('');
				const [response, setResponse] = createSignal('');
				const [useRag, setUseRag] = createSignal(true);
				const [history, setHistory] = createSignal(window.__INITIAL_STATE__.history || []);
				const [loading, setLoading] = createSignal(false);
				const [timer, setTimer] = createSignal(0);

				let timerInterval = null;

				const startLoading = () => {
					setLoading(true);
					setTimer(0);

					const start = Date.now();
					timerInterval = setInterval(() => {
						setTimer(((Date.now() - start) / 1000).toFixed(1));
					}, 100);
				};

				const stopLoading = () => {
					setLoading(false);
					if (timerInterval) clearInterval(timerInterval);
				};

				onCleanup(() => {
					if (timerInterval) clearInterval(timerInterval);
				});

				const handleSubmit = async e => {
					e.preventDefault();
					startLoading();

					const formData = new FormData();
					formData.append('question', question());
					formData.append('use_rag', useRag() ? 'on' : 'off');
					formData.append('clear', 'false');
					const res = await fetch('/question', {
						method: 'POST',
						body: formData,
					});
					const data = await res.json();

					setResponse(data.response || '');
					setHistory(data.history.reverse() || []);
					stopLoading();
				};

				const handleClear = async e => {
					e.preventDefault();
					startLoading();

					const formData = new FormData();
					formData.append('question', '');
					formData.append('use_rag', useRag() ? 'on' : 'off');
					formData.append('clear', 'true');

					const res = await fetch('/', {
						method: 'POST',
						body: formData,
					});
					const data = await res.json();

					setResponse('');
					setHistory(data.history || []);
					setQuestion('');
					stopLoading();
				};

				return html`
					<div class="container">
						<a href="/settings" class="settings-gear" title="Settings">
							<svg
								viewBox="0 0 24 24"
								fill="none"
								stroke="#333"
								stroke-width="2"
								stroke-linecap="round"
								stroke-linejoin="round"
								width="28"
								height="28"
							>
								<circle cx="12" cy="12" r="3" />
								<path
									d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33h.09A1.65 1.65 0 0 0 9 4.09V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51h.09a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"
								/>
							</svg>
						</a>

						<h1>Assist AI</h1>
						<div class="documents-info">
							Assist AI runs locally and answers your questions using the provided documents (in Markdown
							format) and your chat history. With efficient RAG, the model can use a large number of notes
							as context. You can also ask questions without RAG for faster responses. To manage your
							documents, click the button below. To clear the chat history, type "clear".
							<a class="documents-info-button" href="/manage">Manage Documents</a>
						</div>
						<form class="question-form" onSubmit=${handleSubmit}>
							<div class="question-form-row">
								<input
									type="text"
									name="question"
									placeholder="Enter your question"
									class="form-input"
									value=${() => question()}
									required
									onInput=${e => setQuestion(e.target.value)}
									disabled=${() => loading()}
								/>
								<button class="primary-btn" type="submit" disabled=${loading()}>Ask</button>
								<button
									class="secondary-btn"
									type="button"
									onClick=${handleClear}
									disabled=${() => loading()}
								>
									Clear
								</button>
							</div>
							<div class="question-form-row">
								<label style="margin-top: 1em; display: inline-block">
									<input
										type="checkbox"
										name="use_rag"
										value="on"
										checked=${() => useRag()}
										onChange=${e => setUseRag(e.target.checked)}
										disabled=${() => loading()}
									/>
									Provide answer based on documents
								</label>
							</div>
						</form>

						${() =>
							loading()
								? html`
										<div id="loading-row" class="loading-row" style="display: flex">
											<span>Loading...</span>
											<span id="timer" class="loading-timer">${timer()}s</span>
										</div>
								  `
								: () =>
										response()
											? html`
													<div class="response" id="response-block">
														<h2>Response ${useRag() ? '(RAG)' : ''}:</h2>
														<div class="response-scroll">${response()}</div>
													</div>
											  `
											: null}
						${() =>
							history() && history().length > 0
								? html`
										<div class="chat-history">
											<h2>Chat History</h2>
											<div class="chat-history-scroll">
												${history().map(
													entry => html`
														<div class="chat-history-entry">
															<strong>You:</strong> ${entry[0]}<br />
															<strong>AI:</strong> ${entry[1]}
														</div>
													`,
												)}
											</div>
										</div>
								  `
								: null}
					</div>
				`;
			};

			render(App, document.getElementById('root'));
		</script>
	</body>
</html>
