<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<title>Assist AI Client</title>
		<link rel="stylesheet" href="/static/style.css" />

		<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
		<script>
			window.__INITIAL_STATE__ = {
				history: {% if history %}{{ history | tojson }}{% else %}[]{% endif %},
				pending: {% if pending %}true{% else %}false{% endif %}
			};
		</script>

		<style>
			.chat-history-header-row {
				display: flex;
				justify-content: space-between;
				align-items: center;
			}

			.chat-history-header-row h2 {
				margin: 0;
			}

			.save-note-extra {
				resize: vertical;
				min-height: 2.5em;
				font-size: 16px;
			}
		</style>
	</head>
	<body>
		<div id="root"></div>
		<script type="module">
			import { createSignal, onCleanup } from 'https://esm.sh/solid-js@1.8.1';
			import { render } from 'https://esm.sh/solid-js@1.8.1/web';
			import html from 'https://esm.sh/solid-js@1.8.1/html';

			import { PendingNotification } from '/static/pending-notification.js';
			import { SettingsGear } from '/static/settings-gear.js';

			const NOTE_KEY = 'assistai_save_note_extra';

			const App = () => {
				// Form values
				const [question, setQuestion] = createSignal('');
				const [useRag, setUseRag] = createSignal(true);
				const [noteExtra, setNoteExtra] = createSignal(
					typeof localStorage !== 'undefined' && localStorage.getItem(NOTE_KEY)
						? localStorage.getItem(NOTE_KEY)
						: '',
				);

				// Response and history
				const [response, setResponse] = createSignal('');
				const [history, setHistory] = createSignal(window.__INITIAL_STATE__.history || []);

				// UI state
				const [loading, setLoading] = createSignal(false);
				const [timer, setTimer] = createSignal(0);
				const [saveSuccess, setSaveSuccess] = createSignal(false);
				const [pending, setPending] = createSignal(window.__INITIAL_STATE__.pending || false);

				let timerInterval = null;

				const startLoading = () => {
					setLoading(true);
					setTimer(0);

					const start = Date.now();
					timerInterval = setInterval(() => {
						setTimer(((Date.now() - start) / 1000).toFixed(1));
					}, 100);
				};

				const stopLoading = () => {
					setLoading(false);
					if (timerInterval) clearInterval(timerInterval);
				};

				onCleanup(() => {
					if (timerInterval) {
						clearInterval(timerInterval);
					}
				});

				const handleSubmit = async e => {
					e.preventDefault();
					startLoading();

					const formData = new FormData();
					formData.append('question', question());
					formData.append('use_rag', useRag() ? 'on' : 'off');
					formData.append('clear', 'false');

					const res = await fetch('/question', {
						method: 'POST',
						body: formData,
					});
					const data = await res.json();

					const parsedResponse = marked.parse(data.response || '');

					setResponse(parsedResponse);
					setHistory(data.history.reverse() || []);
					stopLoading();
				};

				const handleClear = async e => {
					e.preventDefault();
					startLoading();

					const formData = new FormData();
					formData.append('question', '');
					formData.append('use_rag', useRag() ? 'on' : 'off');
					formData.append('clear', 'true');

					const res = await fetch('/question', {
						method: 'POST',
						body: formData,
					});
					const data = await res.json();

					setResponse('');
					setNoteExtra('');
					setHistory(data.history || []);
					setQuestion('');
					stopLoading();
				};

				const renderHistoryEntry = entry => {
					const user = marked.parse(entry[0] || '');
					const ai = marked.parse(entry[1] || '');
					return html`
						<div class="chat-history-entry">
							<strong>You:</strong>
							<div class="chat-history-markdown" innerHTML=${user}></div>
							<strong>AI:</strong>
							<div class="chat-history-markdown" innerHTML=${ai}></div>
						</div>
					`;
				};

				const handleNoteExtraInput = e => {
					setNoteExtra(e.target.value);

					if (typeof localStorage !== 'undefined') {
						localStorage.setItem(NOTE_KEY, e.target.value);
					}
				};

				const handleSaveNote = async () => {
					const now = new Date();
					const iso = now.toISOString().replace(/[:.]/g, '-').slice(0, 19);
					const filename = `${iso.split('T')[0]}_${iso.split('T')[1]}_assistai_note.md`;

					let note = `# Assist AI Conversation (${now.toLocaleString()})\n\n`;

					const extra = noteExtra();

					if (extra && extra.trim().length > 0) {
						note += `> ${extra.trim().replace(/\n/g, '\n> ')}\n\n`;
					}

					const noteHistory = history().slice();

					noteHistory.reverse().forEach(([q, a], idx) => {
						note += `## Q${idx + 1}\n${q}\n\n## A${idx + 1}\n${a}\n\n`;
					});

					// Save note via API
					const formData = new FormData();
					formData.append('filename', filename);
					formData.append('content', note);

					const res = await fetch('/manage/upload_note', {
						method: 'POST',
						body: formData,
					});

					if (!res.ok) {
						return;
					}
					setSaveSuccess(true);

					setTimeout(() => setSaveSuccess(false), 5000);
					setPending(true);
				};

				return html`
					${() => (pending() ? PendingNotification({ setPending }) : null)}

					<div class="container">
						${SettingsGear()}

						<h1>Assist AI</h1>
						<div class="documents-info">
							Assist AI runs locally and answers your questions using the provided documents (in Markdown
							format) and your chat history. With efficient RAG, the model can use a large number of notes
							as context. You can also ask questions without RAG for faster responses. To manage your
							documents, click the button below. To clear the chat history, type "clear".
							<a class="btn documents-info-button" href="/manage">
								<svg
									width="16px"
									height="16px"
									viewBox="0 0 24 24"
									fill="none"
									xmlns="http://www.w3.org/2000/svg"
								>
									<path
										d="M3 10C3 6.22876 3 4.34315 4.17157 3.17157C5.34315 2 7.22876 2 11 2H13C16.7712 2 18.6569 2 19.8284 3.17157C21 4.34315 21 6.22876 21 10V14C21 17.7712 21 19.6569 19.8284 20.8284C18.6569 22 16.7712 22 13 22H11C7.22876 22 5.34315 22 4.17157 20.8284C3 19.6569 3 17.7712 3 14V10Z"
										stroke="currentColor"
										stroke-width="1.5"
									/>
									<path
										d="M8 12H16"
										stroke="currentColor"
										stroke-width="1.5"
										stroke-linecap="round"
									/>
									<path d="M8 8H16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
									<path
										d="M8 16H13"
										stroke="currentColor"
										stroke-width="1.5"
										stroke-linecap="round"
									/>
								</svg>
								Manage Documents
							</a>
						</div>

						<form class="question-form" onSubmit=${handleSubmit}>
							<div class="question-form-row">
								<input
									type="text"
									name="question"
									placeholder="Enter your question"
									class="form-input"
									value=${() => question()}
									required
									onInput=${e => setQuestion(e.target.value)}
									disabled=${() => loading()}
								/>

								<button class="btn primary-btn" type="submit" disabled=${loading()}>
									<svg
										width="16px"
										height="16px"
										viewBox="0 0 24 24"
										fill="none"
										xmlns="http://www.w3.org/2000/svg"
									>
										<path
											d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 13.5997 2.37562 15.1116 3.04346 16.4525C3.22094 16.8088 3.28001 17.2161 3.17712 17.6006L2.58151 19.8267C2.32295 20.793 3.20701 21.677 4.17335 21.4185L6.39939 20.8229C6.78393 20.72 7.19121 20.7791 7.54753 20.9565C8.88837 21.6244 10.4003 22 12 22Z"
											fill="currentColor"
										/>
									</svg>
									Ask
								</button>

								<button
									class="btn secondary-btn"
									type="button"
									onClick=${handleClear}
									disabled=${() => loading()}
								>
									<svg
										width="16px"
										height="16px"
										viewBox="0 0 24 24"
										fill="none"
										xmlns="http://www.w3.org/2000/svg"
									>
										<path
											d="M18 6V16.2C18 17.8802 18 18.7202 17.673 19.362C17.3854 19.9265 16.9265 20.3854 16.362 20.673C15.7202 21 14.8802 21 13.2 21H10.8C9.11984 21 8.27976 21 7.63803 20.673C7.07354 20.3854 6.6146 19.9265 6.32698 19.362C6 18.7202 6 17.8802 6 16.2V6M4 6H20M16 6L15.7294 5.18807C15.4671 4.40125 15.3359 4.00784 15.0927 3.71698C14.8779 3.46013 14.6021 3.26132 14.2905 3.13878C13.9376 3 13.523 3 12.6936 3H11.3064C10.477 3 10.0624 3 9.70951 3.13878C9.39792 3.26132 9.12208 3.46013 8.90729 3.71698C8.66405 4.00784 8.53292 4.40125 8.27064 5.18807L8 6"
											stroke="currentColor"
											stroke-width="2"
											stroke-linecap="round"
											stroke-linejoin="round"
										/>
									</svg>
									Clear
								</button>
							</div>
							<div class="question-form-row">
								<label style="margin-top: 1em; display: inline-block">
									<input
										type="checkbox"
										name="use_rag"
										value="on"
										checked=${() => useRag()}
										onChange=${e => setUseRag(e.target.checked)}
										disabled=${() => loading()}
									/>
									Provide answer based on documents
								</label>
							</div>
						</form>

						${() =>
							loading()
								? html`
										<div id="loading-row" class="loading-row">
											<span>Loading...</span>
											<span id="timer" class="loading-timer">${timer()}s</span>
										</div>
								  `
								: () =>
										response()
											? html`
													<div class="response" id="response-block">
														<h2>Response:</h2>
														<div class="response-scroll" innerHTML=${response()}></div>
													</div>
											  `
											: null}
						${() =>
							saveSuccess()
								? html`<div class="success-message" style="margin-top: 1em;">
										Conversation saved as note!
								  </div>`
								: null}
						${() =>
							history() && history().length > 0
								? html`
										<div class="chat-history">
											<div class="chat-history-header-row">
												<h2>Chat History</h2>

												<button
													class="btn save-note-btn"
													title="Save conversation as note"
													onClick=${handleSaveNote}
												>
													<svg
														fill="currentColor"
														width="16px"
														height="16px"
														viewBox="0 0 32 32"
														xmlns="http://www.w3.org/2000/svg"
													>
														<path
															d="M26 0H6a6 6 0 0 0-6 6v20a6 6 0 0 0 6 6h20a6 6 0 0 0 6-6V6a6 6 0 0 0-6-6zm-6 2v3a1 1 0 1 0 2 0V2h1v7H9V2zm10 24a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V6a4 4 0 0 1 4-4h1v8a1 1 0 0 0 1 1h16a1 1 0 0 0 1-1V2h1a4 4 0 0 1 4 4zM24 14H8a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h16a1 1 0 0 0 1-1V15a1 1 0 0 0-1-1zm-1 12H9V16h14zM12 20h8a1 1 0 0 0 0-2h-8a1 1 0 0 0 0 2zM12 24h8a1 1 0 0 0 0-2h-8a1 1 0 0 0 0 2z"
														/>
													</svg>
													Save
												</button>
											</div>

											<textarea
												class="form-input save-note-extra"
												placeholder="Add a custom note to include in the saved note (will be saved for next time)..."
												value=${noteExtra()}
												onBlur=${handleNoteExtraInput}
											></textarea>

											<div class="chat-history-scroll">${history().map(renderHistoryEntry)}</div>
										</div>
								  `
								: null}
					</div>
				`;
			};

			render(App, document.getElementById('root'));
		</script>
	</body>
</html>
