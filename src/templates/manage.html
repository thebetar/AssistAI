<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<title>Manage Documents</title>
		<link rel="stylesheet" href="/static/style.css" />

		<script>
			let uploadLoading = false;
			let uploadTimerInterval = null;
			let uploadStartTime = null;

			function startUploadLoading() {
				uploadLoading = true;
				document.getElementById('upload-loading-row').style.display = 'flex';
				uploadStartTime = Date.now();
				updateUploadTimer();
				uploadTimerInterval = setInterval(updateUploadTimer, 100);
			}

			function stopUploadLoading() {
				uploadLoading = false;
				document.getElementById('upload-loading-row').style.display = 'none';
				clearInterval(uploadTimerInterval);
				// Show vectorstore success message
				const vsSuccess = document.getElementById('vectorstore-success');
				if (vsSuccess) vsSuccess.style.display = 'block';
			}

			function updateUploadTimer() {
				if (!uploadLoading) return;
				const now = Date.now();
				const elapsed = ((now - uploadStartTime) / 1000).toFixed(1);
				document.getElementById('upload-timer').textContent = elapsed + 's';
			}

			window.addEventListener('DOMContentLoaded', function () {
				const uploadForm = document.querySelector('.upload-form');
				if (uploadForm) {
					uploadForm.addEventListener('submit', function () {
						startUploadLoading();
					});

					// Add loader to all delete forms
					document.querySelectorAll('.manage-list .manage-list-item form').forEach(function (form) {
						form.addEventListener('submit', function () {
							startUploadLoading();
						});
					});
				}
			});

			function filterFiles() {
				const filter = document.getElementById('file-filter').value.trim().toLowerCase();
				const items = document.querySelectorAll('.manage-list-item');

				items.forEach(item => {
					const filename = item.querySelector('.manage-filename').textContent.toLowerCase();
					item.style.display = filename.includes(filter) ? '' : 'none';
				});
			}
			window.addEventListener('DOMContentLoaded', function () {
				const filterInput = document.getElementById('file-filter');

				if (filterInput) {
					filterInput.addEventListener('input', filterFiles);
				}
			});
		</script>
	</head>
	<body>
		<div class="container">
			<h1>Manage Documents</h1>

			<div id="upload-loading-row" class="loading-row" style="display: none">
				<div class="loader"></div>
				<span>Recreating vector store with new document(s)...</span>
				<span id="upload-timer" class="loading-timer">0.0s</span>
			</div>

			{% if updated %}
			<div class="success-message">Knowledgebase changed successfully!</div>
			<script>
				stopUploadLoading();

				setTimeout(() => {
					const vsSuccess = document.querySelector('.success-message');

					if (vsSuccess) {
						vsSuccess.style.display = 'none';
					}
				}, 5000);
			</script>
			{% endif %}

			<div class="documents-info">
				These documents are used as the knowledge base for answering your questions.
				<a class="documents-info-button" href="/">Back to Chat</a>
			</div>

			<form action="/manage/upload" method="post" enctype="multipart/form-data" class="upload-form">
				<input type="file" name="files" multiple required class="upload-input" />
				<button type="submit" class="upload-btn">Upload</button>
			</form>

			<h2>Files</h2>

			<div style="margin-bottom: 1em">
				<input
					type="text"
					id="file-filter"
					placeholder="Filter files..."
					class="upload-input"
					style="width: 100%"
					autocomplete="off"
				/>
			</div>

			<ul class="manage-list">
				{% for file in files %}
				<li class="manage-list-item">
					<span class="manage-filename">{{ file }}</span>
					<span class="manage-actions">
						<a
							href="/manage/view/{{ file }}"
							target="_blank"
							class="manage-action-btn"
							style="background: #6c757d; margin-bottom: 8px"
							>View</a
						>
						<a
							href="/manage/download/{{ file }}"
							target="_blank"
							class="manage-action-btn manage-download-btn"
							style="margin-bottom: 8px"
							>Download</a
						>
						<form action="/manage/delete/{{ file }}" method="post" style="width: 100%; margin: 0">
							<button type="submit" class="manage-action-btn manage-delete-btn">Delete</button>
						</form>
					</span>
				</li>
				{% else %}
				<li style="color: #888; padding: 8px">No files found.</li>
				{% endfor %}
			</ul>
		</div>
	</body>
</html>
