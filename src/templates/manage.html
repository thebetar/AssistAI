<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<title>Manage Documents</title>
		<link rel="stylesheet" href="/static/style.css" />
	</head>
	<body>
		<div id="root"></div>
		<script type="module">
			import { createSignal, onCleanup, onMount } from 'https://esm.sh/solid-js@1.8.1';
			import { render } from 'https://esm.sh/solid-js@1.8.1/web';
			import html from 'https://esm.sh/solid-js@1.8.1/html';

			const App = () => {
				const [files, setFiles] = createSignal([]);
				const [uploadLoading, setUploadLoading] = createSignal(false);
				const [uploadTimer, setUploadTimer] = createSignal(0);
				const [filter, setFilter] = createSignal('');
				const [success, setSuccess] = createSignal(false);

				let timerInterval = null;

				const fetchFiles = async () => {
					const res = await fetch('/manage/files');
					const data = await res.json();
					setFiles(data.files || []);
				};

				onMount(fetchFiles);

				const startUploadLoading = () => {
					setUploadLoading(true);
					setUploadTimer(0);

					const start = Date.now();
					timerInterval = setInterval(() => {
						setUploadTimer(((Date.now() - start) / 1000).toFixed(1));
					}, 100);
				};

				const stopUploadLoading = () => {
					setUploadLoading(false);

					if (timerInterval) {
						clearInterval(timerInterval);
					}

					setSuccess(true);
					setTimeout(() => setSuccess(false), 5000);
				};

				onCleanup(() => {
					if (timerInterval) clearInterval(timerInterval);
				});

				const handleUpload = async e => {
					e.preventDefault();
					const form = e.target;
					const formData = new FormData(form);

					startUploadLoading();

					const res = await fetch('/manage/upload', {
						method: 'POST',
						body: formData,
					});

					const data = await res.json();

					setFiles(data.files || []);
					stopUploadLoading();

					form.reset();
				};

				const handleDelete = async (e, filename) => {
					e.preventDefault();
					startUploadLoading();
					const res = await fetch(`/manage/delete/${encodeURIComponent(filename)}`, {
						method: 'DELETE',
					});
					const data = await res.json();
					setFiles(data.files || []);
					stopUploadLoading();
				};

				const filteredFiles = () =>
					files().filter(f => f.toLowerCase().includes(filter().trim().toLowerCase()));

				return html`
					<div class="container">
						<div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 1em;">
							<a href="/" class="settings-gear" title="Back to Chat" style="margin-right: 0;">
								<svg
									viewBox="0 0 24 24"
									fill="none"
									stroke="#333"
									stroke-width="2"
									stroke-linecap="round"
									stroke-linejoin="round"
									width="32"
									height="32"
								>
									<circle cx="12" cy="12" r="3" />
									<path
										d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33h.09A1.65 1.65 0 0 0 9 4.09V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51h.09a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"
									/>
								</svg>
							</a>
						</div>

						<h1>Manage Documents</h1>

						${() =>
							uploadLoading()
								? html`
										<div id="upload-loading-row" class="loading-row" style="display: flex">
											<span>Recreating vector store with new document(s)...</span>
											<span id="upload-timer" class="loading-timer">${uploadTimer()}s</span>
										</div>
								  `
								: null}
						${() =>
							success()
								? html` <div class="success-message">Knowledgebase updated successfully!</div> `
								: null}

						<div class="documents-info">
							These documents are used as the knowledge base for answering your questions.
							<a class="btn documents-info-button" href="/">
								<svg
									width="16px"
									height="16px"
									viewBox="0 0 24 24"
									fill="none"
									xmlns="http://www.w3.org/2000/svg"
								>
									<path
										d="M3 10C3 6.22876 3 4.34315 4.17157 3.17157C5.34315 2 7.22876 2 11 2H13C16.7712 2 18.6569 2 19.8284 3.17157C21 4.34315 21 6.22876 21 10V14C21 17.7712 21 19.6569 19.8284 20.8284C18.6569 22 16.7712 22 13 22H11C7.22876 22 5.34315 22 4.17157 20.8284C3 19.6569 3 17.7712 3 14V10Z"
										stroke="currentColor"
										stroke-width="1.5"
									/>
									<path
										d="M8 12H16"
										stroke="currentColor"
										stroke-width="1.5"
										stroke-linecap="round"
									/>
									<path d="M8 8H16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
									<path
										d="M8 16H13"
										stroke="currentColor"
										stroke-width="1.5"
										stroke-linecap="round"
									/>
								</svg>
								Back to Chat
							</a>
						</div>

						<form
							action="/manage/upload"
							method="post"
							enctype="multipart/form-data"
							class="upload-form"
							onSubmit=${handleUpload}
						>
							<input type="file" name="files" multiple required class="upload-input" />
							<button type="submit" class="btn upload-btn" disabled=${() => uploadLoading()}>
								<svg
									width="16px"
									height="16px"
									viewBox="0 0 24 24"
									fill="none"
									xmlns="http://www.w3.org/2000/svg"
								>
									<path
										d="M12 4V16M12 4L8 8M12 4L16 8"
										stroke="currentColor"
										stroke-width="2"
										stroke-linecap="round"
										stroke-linejoin="round"
									/>
									<rect x="4" y="20" width="16" height="2" rx="1" fill="currentColor" stroke="none" />
								</svg>

								Upload
							</button>
						</form>

						<h2>Files</h2>

						<div style="display: flex;">
							<input
								type="text"
								id="file-filter"
								placeholder="Filter files..."
								class="form-input"
								style="flex: 1;"
								autocomplete="off"
								value=${() => filter()}
								onInput=${e => setFilter(e.target.value)}
								disabled=${() => uploadLoading()}
							/>
						</div>

						<ul class="manage-list">
							${() =>
								filteredFiles().length > 0
									? filteredFiles().map(
											file =>
												html`
													<li class="manage-list-item">
														<span class="manage-filename">${file}</span>
														<span class="manage-actions">
															<a
																href=${`/manage/view/${encodeURIComponent(file)}`}
																target="_blank"
																class="manage-action-btn"
																style="background: #6c757d; margin-bottom: 8px"
															>
																<svg
																	width="14px"
																	height="14px"
																	viewBox="0 0 24 24"
																	fill="none"
																	xmlns="http://www.w3.org/2000/svg"
																	style="vertical-align: middle; margin-right: 4px;"
																>
																	<path
																		d="M1 12C1 12 5 5 12 5C19 5 23 12 23 12C23 12 19 19 12 19C5 19 1 12 1 12Z"
																		stroke="currentColor"
																		stroke-width="2"
																		stroke-linecap="round"
																		stroke-linejoin="round"
																	/>
																	<circle
																		cx="12"
																		cy="12"
																		r="3"
																		stroke="currentColor"
																		stroke-width="2"
																		stroke-linecap="round"
																		stroke-linejoin="round"
																	/>
																</svg>
																View
															</a>
															<a
																href=${`/manage/download/${encodeURIComponent(file)}`}
																target="_blank"
																class="manage-action-btn manage-download-btn"
																style="margin-bottom: 8px"
															>
																<svg
																	width="16px"
																	height="16px"
																	viewBox="0 0 24 24"
																	fill="none"
																	xmlns="http://www.w3.org/2000/svg"
																>
																	<path
																		d="M12 16V4M12 16L8 12M12 16L16 12"
																		stroke="currentColor"
																		stroke-width="2"
																		stroke-linecap="round"
																		stroke-linejoin="round"
																	/>
																	<rect
																		x="4"
																		y="18"
																		width="16"
																		height="2"
																		rx="1"
																		fill="currentColor"
																		stroke="none"
																	/>
																</svg>
																Download
															</a>
															<form
																style="width: 100%; margin: 0; display: inline"
																onSubmit=${e => handleDelete(e, file)}
															>
																<button
																	type="submit"
																	class="manage-action-btn manage-delete-btn"
																	disabled=${() => uploadLoading()}
																>
																	<svg
																		width="14px"
																		height="14px"
																		viewBox="0 0 24 24"
																		fill="none"
																		xmlns="http://www.w3.org/2000/svg"
																		style="vertical-align: middle; margin-right: 4px;"
																	>
																		<path
																			d="M3 6H5H21"
																			stroke="currentColor"
																			stroke-width="2"
																			stroke-linecap="round"
																			stroke-linejoin="round"
																		/>
																		<path
																			d="M8 6V4C8 2.89543 8.89543 2 10 2H14C15.1046 2 16 2.89543 16 4V6M19 6V20C19 21.1046 18.1046 22 17 22H7C5.89543 22 5 21.1046 5 20V6M10 11V17M14 11V17"
																			stroke="currentColor"
																			stroke-width="2"
																			stroke-linecap="round"
																			stroke-linejoin="round"
																		/>
																	</svg>
																	Delete
																</button>
															</form>
														</span>
													</li>
												`,
									  )
									: html`<li style="color: #888; padding: 8px">No files found.</li>`}
						</ul>
					</div>
				`;
			};

			render(App, document.getElementById('root'));
		</script>
	</body>
</html>
